<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Кадастрова карта</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>

<style>
:root { --btn-base:#5aa0e5; --btn-hover:#3f7fc1; --btn-active:#f59e0b; }
html,body,#map{width:100%;height:100%;margin:0;}

#map.coords-mode{ cursor: crosshair !important; }
#map.coords-mode *{ cursor: crosshair !important; }

#infoPanel{position:absolute;top:15px;right:15px;width:360px;background:#fff;padding:14px;border-radius:14px;box-shadow:0 10px 25px rgba(0,0,0,.2);font-size:14px;z-index:1000;display:none;}
#infoPanel.visible{display:block;}
#infoHeader{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;}
#closeInfo{border:none;background:#ef4444;color:#fff;border-radius:6px;padding:2px 8px;cursor:pointer;}

#infoContent table{width:100%;border-collapse:separate;border-spacing:0 6px;}
#infoContent td:first-child{width:150px;font-weight:500;}
td.value{background:#f0f4ff;padding:6px 8px;border-radius:6px;}
td.value.active{background:#dbeafe;}

button,.rowEditBtn{
  border:none;border-radius:6px;padding:6px 10px;
  background:var(--btn-base);color:#fff;
  cursor:pointer;transition:.2s;font-size:13px;
}
button:hover,.rowEditBtn:hover{background:var(--btn-hover);}
button.active,.rowEditBtn.active{background:var(--btn-active);}

#searchControls,#editControl,#coordsControl,#layersControl{
  position:absolute;z-index:1000;
}
#searchControls{top:15px;left:15px;display:flex;gap:5px;}
#editControl{top:60px;left:15px;display:flex;flex-direction:column;gap:6px;}
#coordsControl{bottom:15px;left:15px;}
#layersControl{bottom:15px;left:50%;transform:translateX(-50%);display:flex;gap:6px;}

.leaflet-draw .leaflet-marker-icon{
  border-radius:50%;width:12px !important;height:12px !important;
  margin-left:-6px;margin-top:-6px;border:2px solid #4f46e5;background:#fff;
}
</style>
</head>

<body>
<div id="map"></div>

<div id="searchControls">
  <input id="searchInput" placeholder="Пошук…">
  <button id="resetSearch">✖</button>
</div>

<div id="editControl">
  <button id="addPolygonBtn">Додати</button>
  <button id="editPolygonBtn">Редагувати вершини</button>
  <button id="deletePolygonBtn">Видалити</button>
</div>

<div id="coordsControl">
  <button id="coordsModeBtn">Координати</button>
</div>

<div id="layersControl">
  <button id="gkkBtn" class="active">GKK</button>
  <button id="esriBtn">ESRI</button>
  <button id="googleBtn">Google</button>
</div>

<div id="infoPanel">
  <div id="infoHeader">
    <b>Інформація</b>
    <button id="closeInfo">✖</button>
  </div>
  <div id="infoContent"></div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
<script src="https://unpkg.com/leaflet-geometryutil@0.10.1/src/leaflet.geometryutil.js"></script>

<script>
/* ---------------- MAP ---------------- */
const map=L.map('map').setView([48.752963,30.989256],15);
map.zoomControl.remove();
L.control.zoom({position:'bottomright'}).addTo(map);

const gkkLayer=L.tileLayer('https://map50.gki.com.ua/api-user/rtile/carto_2240035321813140995/ua/{z}/{x}/{y}.png').addTo(map);
const esriLayer=L.tileLayer('https://services.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');
const googleLayer=L.tileLayer('https://www.google.com/maps/vt?lyrs=s@189&x={x}&y={y}&z={z}');

const editableLayer=new L.FeatureGroup().addTo(map);

/* ---------------- STYLES ---------------- */
const stylePolygon=()=>({color:'#3388ff',weight:1.3,fillColor:'#3388ff',fillOpacity:.12});
const highlightPolygon=l=>l.setStyle({fillColor:'#ffe666',fillOpacity:.45});
const resetPolygon=l=>l.setStyle(stylePolygon());

/* ---------------- ATTRIBUTES ---------------- */
const keyNames={
  Cadnum:'Кадастровий номер',Area:'Площа за документами (га)',area_2:'Площа в натурі (га)',
  purpose:'Цільове призначення',Qwner:'Власник',Num_Ovner:'К-сть власників',
  tenant:'Землекористувач',St_reg:'Дата реєстрації',
  Street:'Вулиця',Build_num:'№ будинку',note:'Примітка'
};

let activeLayer=null;
let activeAttrEdit=null;

/* ---------------- INFO PANEL ---------------- */
function showInfo(layer){
  activeLayer=layer;
  let html='<table>';
  for(const k in keyNames){
    const v=layer.feature.properties[k]||'';
    html+=`<tr>
      <td>${keyNames[k]}</td>
      <td class="value" data-key="${k}">${v}</td>
      <td>${k!=='Cadnum'?`<button class="rowEditBtn" data-key="${k}">✎</button>`:''}</td>
    </tr>`;
  }
  html+='</table>';
  infoContent.innerHTML=html;
  infoPanel.classList.add('visible');

  document.querySelectorAll('.rowEditBtn').forEach(btn=>{
    btn.onclick=()=>{
      const key=btn.dataset.key;
      const td=document.querySelector(`td[data-key="${key}"]`);

      if(activeAttrEdit && activeAttrEdit.btn===btn){
        finishAttrEdit(); return;
      }
      if(activeAttrEdit) finishAttrEdit();

      td.contentEditable=true;
      td.classList.add('active');
      btn.classList.add('active');
      td.focus();

      activeAttrEdit={td,btn,key};
      td.onblur=finishAttrEdit;
    };
  });
}

function finishAttrEdit(){
  if(!activeAttrEdit) return;
  const {td,btn,key}=activeAttrEdit;
  td.contentEditable=false;
  td.classList.remove('active');
  btn.classList.remove('active');
  activeLayer.feature.properties[key]=td.innerText.trim();
  saveAll();
  activeAttrEdit=null;
}

/* ---------------- DRAW ---------------- */
const drawControl=new L.Draw.Polygon(map,{allowIntersection:false,shapeOptions:stylePolygon()});
addPolygonBtn.onclick=()=>drawControl._enabled?drawControl.disable():drawControl.enable();

map.on(L.Draw.Event.CREATED,e=>{
  const l=e.layer;
  const ll=l.getLatLngs()[0];
  l.feature={type:'Feature',properties:{Cadnum:'3523681200:'+Date.now(),area_2:+(L.GeometryUtil.geodesicArea(ll)/10000).toFixed(4)},geometry:{type:'Polygon',coordinates:[ll.map(p=>[p.lng,p.lat])]}}
  editableLayer.addLayer(l);
  highlightPolygon(l);
  showInfo(l);
  saveAll();
});

/* ---------------- LOAD ---------------- */
fetch('/polygons.json').then(r=>r.json()).then(d=>{
  L.geoJSON(d,{style:stylePolygon,onEachFeature:(f,l)=>{
    editableLayer.addLayer(l);
    l.on('click',()=>{
      editableLayer.eachLayer(resetPolygon);
      highlightPolygon(l);
      showInfo(l);
    });
  }});
});

/* ---------------- COORDS MODE ---------------- */
let coordsMode=false,tempMarker=null;
coordsModeBtn.onclick=()=>{
  coordsMode=!coordsMode;
  coordsModeBtn.classList.toggle('active',coordsMode);
  map.getContainer().classList.toggle('coords-mode',coordsMode);
  if(!coordsMode && tempMarker){map.removeLayer(tempMarker);tempMarker=null;}
};

map.on('click',e=>{
  if(!coordsMode) return;
  if(tempMarker) map.removeLayer(tempMarker);
  tempMarker=L.marker(e.latlng).addTo(map);
  infoContent.innerHTML=`<table><tr><td>Координати</td><td>${e.latlng.lat.toFixed(6)}, ${e.latlng.lng.toFixed(6)}</td></tr></table>`;
  infoPanel.classList.add('visible');
});

/* ---------------- DELETE ---------------- */
deletePolygonBtn.onclick=()=>{
  if(activeLayer && confirm('Видалити полігон?')){
    editableLayer.removeLayer(activeLayer);
    infoPanel.classList.remove('visible');
    activeLayer=null;
    saveAll();
  }
};

/* ---------------- SAVE ---------------- */
function saveAll(){
  fetch('https://kalnibolota.onrender.com/polygons',{
    method:'POST',
    headers:{'Content-Type':'application/json'},
    body:JSON.stringify(editableLayer.toGeoJSON())
  });
}
</script>
</body>
</html>
